<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hmail.org - Почта</title>
<style>
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #fce4e4;
    color: #a12323;
    display: flex; flex-direction: column; min-height: 100vh;
  }
  header {
    background: #db5656;
    color: white;
    padding: 15px 20px;
    font-size: 1.7rem;
    font-weight: bold;
    text-align: center;
    letter-spacing: 2px;
    user-select: none;
  }
  main {
    flex-grow: 1;
    display: flex;
    padding: 20px;
    gap: 20px;
  }
  /* Левое меню (вход/регистрация) */
  #auth-panel {
    flex: 0 0 300px;
    background: #f9c9c9;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 10px #d46f6f;
    animation: fadeIn 1s ease forwards;
  }
  #auth-panel h2 {
    margin-top: 0;
  }
  label {
    display: block;
    margin-top: 15px;
  }
  input[type="text"], input[type="password"] {
    width: 100%;
    padding: 8px 10px;
    margin-top: 6px;
    border-radius: 6px;
    border: 1.5px solid #a12323;
    font-size: 1rem;
  }
  button {
    margin-top: 20px;
    width: 100%;
    background: #db5656;
    border: none;
    color: white;
    padding: 12px;
    font-size: 1.1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #a12323;
  }
  /* Почтовый ящик */
  #mailbox {
    flex-grow: 1;
    background: #ffe3e3;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 10px #d46f6f;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
  }
  #mailbox.active {
    opacity: 1;
    pointer-events: auto;
  }
  #user-info {
    padding: 10px 20px;
    background: #db5656;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    display: flex; justify-content: space-between; align-items: center;
  }
  #user-info button {
    width: auto;
    background: #a12323;
    padding: 6px 12px;
    font-size: 0.9rem;
  }
  #messages-list {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px 20px;
  }
  .message {
    background: white;
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 0 5px #c77;
    animation: slideIn 0.3s ease forwards;
  }
  .message.from-me {
    background: #ffb6b6;
    align-self: flex-end;
  }
  .message strong {
    color: #a12323;
  }
  #compose {
    padding: 15px 20px;
    border-top: 1px solid #d46f6f;
    display: flex;
    gap: 10px;
  }
  #compose input[type="text"] {
    flex-grow: 1;
    border-radius: 8px;
    padding: 10px;
    font-size: 1rem;
    border: 1.5px solid #a12323;
  }
  #compose button {
    flex-shrink: 0;
    width: 120px;
  }
  /* Поддержка */
  #support {
    margin-top: 20px;
    background: #f9c9c9;
    padding: 12px;
    border-radius: 10px;
    box-shadow: 0 0 8px #d46f6f;
    font-size: 0.9rem;
  }
  #support h3 {
    margin-top: 0;
  }
  #support p {
    margin-bottom: 6px;
  }
  #support textarea {
    width: 100%;
    height: 70px;
    resize: none;
    border-radius: 6px;
    border: 1.5px solid #a12323;
    padding: 8px;
    font-size: 1rem;
  }
  #support button {
    width: 100%;
    margin-top: 8px;
  }
  footer {
    text-align: center;
    padding: 12px 0;
    background: #db5656;
    color: white;
    font-size: 0.9rem;
    user-select: none;
  }
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }
  @keyframes slideIn {
    from {opacity: 0; transform: translateY(15px);}
    to {opacity: 1; transform: translateY(0);}
  }
</style>
</head>
<body>

<header>Hmail.org</header>

<main>
  <section id="auth-panel">
    <h2>Войти или создать почту</h2>

    <div id="register-form">
      <label>Имя пользователя (без @hmail.org):
        <input type="text" id="reg-username" autocomplete="off" />
      </label>
      <label>Пароль (не обязательно):
        <input type="password" id="reg-password" autocomplete="new-password" />
      </label>
      <button id="register-btn">Создать аккаунт</button>
    </div>

    <hr />

    <div id="login-form">
      <label>Полное имя (например, user@hmail.org):
        <input type="text" id="login-email" autocomplete="username" />
      </label>
      <label>Пароль:
        <input type="password" id="login-password" autocomplete="current-password" />
      </label>
      <button id="login-btn">Войти</button>
    </div>

    <hr />

    <button id="guest-btn">Войти как гость</button>
  </section>

  <section id="mailbox">
    <div id="user-info">
      <span id="user-email"></span>
      <button id="logout-btn">Выйти</button>
    </div>

    <div id="messages-list"></div>

    <form id="compose">
      <input type="text" id="recipient" placeholder="Кому (имя без @hmail.org)" autocomplete="off" required />
      <input type="text" id="message-text" placeholder="Написать сообщение..." autocomplete="off" required />
      <button type="submit">Отправить</button>
    </form>

    <div id="support">
      <h3>Поддержка</h3>
      <p>Если есть вопросы или проблемы — напишите нам:</p>
      <textarea id="support-message" placeholder="Ваше сообщение"></textarea>
      <button id="support-send">Отправить поддержку</button>
      <div id="support-feedback" style="margin-top:8px;color:#a12323;"></div>
    </div>
  </section>
</main>

<footer>© 2025 Hmail.org Все права защищены.</footer>

<!-- Firebase SDK (compat версии для простоты) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Конфигурация Firebase из твоего аккаунта
  const firebaseConfig = {
    apiKey: "AIzaSyBqdQ2iUlh7XYXNgsO2YlCtUZX-8-l8wRQ",
    authDomain: "hmail-7b2c2.firebaseapp.com",
    projectId: "hmail-7b2c2",
    storageBucket: "hmail-7b2c2.appspot.com",
    messagingSenderId: "694751482331",
    appId: "1:694751482331:web:76057c74cd82e78bf3d7fe"
  };

  // Инициализация Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Элементы UI
  const regUsernameInput = document.getElementById('reg-username');
  const regPasswordInput = document.getElementById('reg-password');
  const registerBtn = document.getElementById('register-btn');

  const loginEmailInput = document.getElementById('login-email');
  const loginPasswordInput = document.getElementById('login-password');
  const loginBtn = document.getElementById('login-btn');

  const guestBtn = document.getElementById('guest-btn');

  const authPanel = document.getElementById('auth-panel');
  const mailbox = document.getElementById('mailbox');
  const userEmailSpan = document.getElementById('user-email');
  const logoutBtn = document.getElementById('logout-btn');

  const messagesList = document.getElementById('messages-list');
  const composeForm = document.getElementById('compose');
  const recipientInput = document.getElementById('recipient');
  const messageTextInput = document.getElementById('message-text');

  const supportTextarea = document.getElementById('support-message');
  const supportSendBtn = document.getElementById('support-send');
  const supportFeedback = document.getElementById('support-feedback');

  // Помощник для генерации email с @hmail.org
  function makeEmail(username) {
    return username.trim().toLowerCase() + '@hmail.org';
  }

  // Создание пользователя (регистрация)
  registerBtn.addEventListener('click', () => {
    const username = regUsernameInput.value.trim();
    let password = regPasswordInput.value;
    if (!username) {
      alert('Введите имя пользователя для регистрации');
      return;
    }
    const email = makeEmail(username);

    if (!password) password = Math.random().toString(36).slice(-8); // случайный пароль если пустой

    auth.createUserWithEmailAndPassword(email, password)
      .then(({ user }) => {
        alert(`Аккаунт ${email} создан! Пожалуйста, войдите.`);
        regUsernameInput.value = '';
        regPasswordInput.value = '';
      })
      .catch(error => {
        alert('Ошибка регистрации: ' + error.message);
      });
  });

  // Вход по email и паролю
  loginBtn.addEventListener('click', () => {
    const email = loginEmailInput.value.trim();
    const password = loginPasswordInput.value;
    if (!email || !password) {
      alert('Введите полный email и пароль');
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .catch(error => {
        alert('Ошибка входа: ' + error.message);
      });
  });

  // Вход как гость (анонимно)
  guestBtn.addEventListener('click', () => {
    auth.signInAnonymously()
      .catch(error => {
        alert('Ошибка входа гостем: ' + error.message);
      });
  });

  // Выход
  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  // Слушаем изменения авторизации
  auth.onAuthStateChanged(user => {
    if (user) {
      authPanel.style.display = 'none';
      mailbox.classList.add('active');
      if (user.isAnonymous) {
        userEmailSpan.textContent = 'Гость (anon)';
      } else {
        userEmailSpan.textContent = user.email;
      }
      subscribeMessages(user);
      updateOnlineStatus(user, true);
    } else {
      mailbox.classList.remove('active');
      authPanel.style.display = 'block';
      messagesList.innerHTML = '';
    }
  });

  // Обновляем статус онлайн/офлайн
  function updateOnlineStatus(user, online) {
    if (!user || user.isAnonymous) return;
    const userStatusRef = db.collection('onlineStatus').doc(user.uid);
    userStatusRef.set({
      email: user.email,
      online: online,
      lastChanged: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  window.addEventListener('beforeunload', () => {
    const user = auth.currentUser;
    if (user && !user.isAnonymous) {
      updateOnlineStatus(user, false);
    }
  });

  // Подписка на сообщения (получаем все письма, где получатель или отправитель - текущий пользователь)
  function subscribeMessages(user) {
    if (window.unsubscribeMessages) window.unsubscribeMessages();

    window.unsubscribeMessages = db.collection('messages')
      .where('participants', 'array-contains', user.email)
      .orderBy('createdAt', 'asc')
      .onSnapshot(snapshot => {
        messagesList.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          renderMessage(data, user.email);
        });
        messagesList.scrollTop = messagesList.scrollHeight;
      });
  }

  // Отобразить сообщение
  function renderMessage(data, currentEmail) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message');
    if (data.sender === currentEmail) msgDiv.classList.add('from-me');
    msgDiv.innerHTML = `<strong>${data.sender}</strong>: ${escapeHtml(data.text)}`;
    messagesList.appendChild(msgDiv);
  }

  // Отправка сообщения
  composeForm.addEventListener('submit', e => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return alert('Вы не авторизованы');

    const recipientName = recipientInput.value.trim().toLowerCase();
    if (!recipientName) return alert('Введите имя получателя');

    const recipientEmail = makeEmail(recipientName);
    const text = messageTextInput.value.trim();
    if (!text) return alert('Введите текст сообщения');

    // Добавляем письмо в Firestore
    db.collection('messages').add({
      sender: user.isAnonymous ? 'guest@hmail.org' : user.email,
      recipient: recipientEmail,
      participants: [user.isAnonymous ? 'guest@hmail.org' : user.email, recipientEmail],
      text: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      messageTextInput.value = '';
      recipientInput.value = '';
    }).catch(err => {
      alert('Ошибка при отправке сообщения: ' + err.message);
    });
  });

  // Поддержка: отправка сообщения в коллекцию supportMessages
  supportSendBtn.addEventListener('click', () => {
    const user = auth.currentUser;
    const msg = supportTextarea.value.trim();
    if (!msg) {
      supportFeedback.textContent = 'Введите сообщение поддержки.';
      return;
    }
    if (!user) {
      supportFeedback.textContent = 'Вы должны быть авторизованы для отправки поддержки.';
      return;
    }
    db.collection('supportMessages').add({
      user: user.email || 'guest@hmail.org',
      message: msg,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      supportFeedback.style.color = '#228822';
      supportFeedback.textContent = 'Сообщение поддержки отправлено.';
      supportTextarea.value = '';
      setTimeout(() => { supportFeedback.textContent = ''; }, 4000);
    }).catch(err => {
      supportFeedback.style.color = '#a12323';
      supportFeedback.textContent = 'Ошибка отправки поддержки: ' + err.message;
    });
  });

  // Экранирование HTML для безопасности
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
